import numpy as np
from novatel_oem7_msgs.msg import BESTPOS
from novatel_oem7_msgs.msg import BESTVEL
from novatel_oem7_msgs.msg import INSPVA
import rospy
from std_msgs.msg import String
import actuator
import math
import pid
import time
from geopy.distance import geodesic


lat = 0
lng = 0
heading = 0
wp_threshold = 1.111395e5
#GNSS position
def callback_latlong(data):
    global lat,lng
    lat = data.lat
    lng = data.lon

#GNSS heading
def callback_heading(data):

    global heading
    heading=data.azimuth  
rospy.init_node('Navigation', anonymous=True)
#ROS subscription
rospy.Subscriber("/novatel/oem7/bestpos",BESTPOS, callback_latlong)
rospy.Subscriber("/novatel/oem7/inspva",INSPVA, callback_heading)

#TCP connection
obj = actuator.controller("169.254.178.227",5001)
obj.connect()

#PID controller
Kp = 1.65971
Ki = 0.00007
Kd = 0.710
rate_min = -100
rate_max = 100
pid_controller = pid.PIDController(Kp, Ki, Kd, rate_min, rate_max)

def calculate_steer_angle(currentLocation, wp, heading):
    """
    This function takes three inputs:
        - currentLocation: a list of two float values representing the current location
        - wp: a waypoint value
        - heading: a heading value
    It then calculates the steer output based on the current location, waypoint, and heading, and returns the steer output value.
    """
    off_y = - currentLocation[0] + float(waypoints[wp][0])
    off_x = - currentLocation[1] + float(waypoints[wp][1])

    # calculate bearing based on position error
    bearing_ppc =90.00 + math.atan2(-off_y, off_x) * 57.2957795  # Adding 90.00 is a common adjustment to align the bearing with cardinal directions (e.g., north as 0 degrees).

    # convert negative bearings to positive by adding 360 degrees
    if bearing_ppc < 0:
        bearing_ppc += 360.00

    # calculate the difference between heading and bearing
    bearing_diff = heading - bearing_ppc

    # normalize bearing difference to range between -180 and 180 degrees
    if bearing_diff < -180:
        bearing_diff = bearing_diff + 360

    if bearing_diff > 180:
        bearing_diff = bearing_diff - 360

    steer_output =  np.arctan(-1 * 2 * 3.5 * np.sin(np.pi * bearing_diff / 180) / 8)

    steer_output = np.clip(steer_output, a_min = -30, a_max = 30)
    steer_output = (50/3)*steer_output*(180/np.pi)
    steer_output = np.clip(steer_output, a_min = -500, a_max = 500)
    return steer_output

#Load waypoints
def load_waypoints(file_path):
        data_list = []
        try:
            with open(file_path, "r") as file:
                lines = file.readlines()
                for line in lines:
                    # Split each line using a comma as delimiter and convert values to floats
                    values = [float(x.strip()) for x in line.strip().split()]
                    data_list.append(values)
        except FileNotFoundError:
            print("File not found.")
        except Exception as e:
            print(f"Error occurred: {e}")
        return data_list



#file_path = 'output.txt'
#waypoints = load_waypoints(file_path)
waypoints = [[17.6019853172724,78.12679868449509],
[17.601985307988766,78.12679839754564],
[17.601985295128806,78.12679770589585],
[17.601985277526353,78.12679729766629],
[17.601985262665607,78.12679639143585],
[17.601985237944017,78.12679589684895],
[17.60198517555279,78.12679480530802],
[17.6019851491294,78.12679423820123],
[17.601985143637194,78.12679300319661],
[17.601985124081345,78.12679232818091],
[17.60198506938006,78.12679082703022],
[17.601985032717195,78.12679002466689],
[17.60198500435799,78.12678828571146],
[17.601984969944375,78.12678733226655],
[17.6019849159888,78.12678529610766],
[17.601984884657654,78.12678419936522],
[17.601984824990897,78.12678185316157],
[17.601984777628918,78.12678058024241],
[17.601984704487336,78.12677784600635],
[17.60198463852155,78.12677640513613],
[17.60198453857872,78.12677332831323],
[17.60198451268426,78.12677170380137],
[17.601984447731475,78.12676828743912],
[17.601984368702944,78.12676473258105],
[17.60198433506749,78.12676288050802],
[17.601984297006044,78.12676100984342],
[17.601984242553247,78.12675719461573],
[17.601984189968164,78.12675328949314],
[17.60198416387877,78.12675128358902],
[17.60198408071593,78.12674725691649],
[17.60198401841564,78.12674522517224],
[17.601983991238583,78.12674112987854],
[17.601983945816848,78.12673902396425],
[17.601983882870407,78.12673484890156],
[17.601983863083,78.12673274704864],
[17.601983871182885,78.12672850636342],
[17.601983897835215,78.12672636207749],
[17.601983938366583,78.12672206490217],
[17.601983968557732,78.1267199219312],
[17.601984104394642,78.12671574846429],
[17.601984209817616,78.12671369632115],
[17.601984483102523,78.12670976321675],
[17.601984634181047,78.12670787809996],
[17.601985022219043,78.12670425151337],
[17.60198524637982,78.12670247743914],
[17.601985773026627,78.1266990031825],
[17.60198606552733,78.12669730273538],
[17.601986727771877,78.126693929218],
[17.601987084445966,78.12669224325357],
[17.601987917152602,78.12668896562454],
[17.601988337131385,78.12668732194656],
[17.601989267806537,78.12668404507482],
[17.601989774143185,78.12668240421375],
[17.60199080353423,78.12667915188327],
[17.60199134784219,78.12667754441868],
[17.601992523742187,78.1266743442364],
[17.601993179200843,78.12667276852814],
[17.601994569261453,78.12666966526349],
[17.601995243231038,78.12666809667644],
[17.601996663102657,78.1266650237176],
[17.601997475154363,78.1266635414595],
[17.60199905957051,78.12666055909183],
[17.601999851186417,78.12665903277887],
[17.602001620647403,78.12665611156471],
[17.602002575961084,78.12665465686995],
[17.602004544170537,78.12665177095174],
[17.602005521033078,78.12665030682231],
[17.6020076913045,78.12664746931155],
[17.602008861895996,78.12664602457066],
[17.602011282445673,78.12664322963337],
[17.6020125173666,78.12664181663646],
[17.602015094077327,78.12663900823323],
[17.60201655923892,78.12663758445896],
[17.602019443521133,78.12663485249728],
[17.602020974715167,78.12663352819835],
[17.602024148497946,78.12663089667333],
[17.60202583060414,78.12662960841774],
[17.602029355619415,78.12662705613617],
[17.602031190340846,78.12662578816409],
[17.602034997957343,78.12662339471527],
[17.602036948078798,78.12662226362289],
[17.60204110755428,78.12662002730734],
[17.60204318291054,78.12661892777639],
[17.602047544630295,78.12661681313318],
[17.602049829451172,78.12661588896717],
[17.602054588116555,78.12661403296893],
[17.602059628827824,78.126612421167],
[17.602062240136007,78.12661158825647],
[17.602067484087684,78.12661020408537],
[17.602070195782137,78.12660954418483],
[17.60207574897367,78.12660832283238],
[17.602078561577024,78.1266078333581],
[17.60208440717939,78.12660689410207],
[17.602087424692368,78.1266065916096],
[17.602093459671924,78.12660573488606],
[17.602096546718858,78.12660530689995],
[17.602102883492442,78.12660456134303],
[17.602106089492565,78.12660419363321],
[17.60210935467482,78.12660384065687],
[17.60211596554357,78.12660309879364],
[17.602122751661042,78.12660236331898],
[17.60212616413026,78.12660199703716],
[17.602133126465596,78.12660125383113],
[17.602136674349943,78.12660092490592],
[17.6021438474333,78.1266003032997],
[17.602147493123237,78.12659999738999],
[17.602154884893533,78.12659943561978],
[17.602158629269496,78.12659913464788],
[17.602166212525738,78.1265986446852],
[17.60217006144897,78.1265984175345],
[17.602177722323624,78.12659797643086],
[17.602181683462145,78.1265977628618],
[17.60218966882573,78.12659736400697],
[17.602193730876106,78.1265971707974],
[17.602201890367905,78.12659688026758],
[17.602206037089605,78.12659673894052],
[17.602214435183225,78.12659648824125],
[17.60221867411085,78.12659640973187],
[17.60222726344318,78.12659628848526],
[17.60223159243587,78.12659625273204],
[17.602240446752248,78.12659607028618],
[17.602244895048006,78.12659598970026],
[17.602253839711143,78.12659593925703],
[17.602258333697947,78.12659593203884],
[17.60226732959324,78.12659581110563],
[17.602271848012062,78.12659575161767],
[17.60228094421043,78.12659569467007],
[17.602285497628475,78.12659568534329],
[17.602294602025122,78.12659561416478],
[17.602299100004437,78.12659561507583],
[17.602308085428067,78.12659558891937],
[17.602312576564252,78.12659554649134],
[17.602321519118792,78.12659548081733],
[17.602325986378172,78.12659548718491],
[17.602334875682647,78.12659544072136],
[17.602339298946468,78.1265954069235],
[17.6023480740779,78.12659537310127],
[17.602352455434268,78.12659536152148],
[17.602361165905936,78.1265953439864],
[17.60236548118005,78.1265953388812],
[17.602374073601037,78.12659532334966],
[17.602378309967918,78.1265953387936],
[17.602386732006767,78.12659535280201],
[17.60239083137937,78.12659534414438],
[17.602398851166186,78.12659537701565],
[17.602402737338707,78.12659542218447],
[17.60241031294269,78.12659549656045],
[17.602414018144476,78.12659550663487],
[17.60242127607939,78.12659550693074],
[17.602424887579506,78.12659551973768],
[17.602432031654487,78.12659560124929],
[17.60243556261616,78.12659563303035],
[17.602442594178484,78.12659562690149],
[17.602449546408717,78.12659562359364],
[17.60245300709322,78.12659565283711],
[17.602459861757712,78.12659568160282],
[17.60246325466354,78.12659569754294],
[17.60247003078657,78.1265956837329],
[17.602473389508333,78.12659571244562],
[17.602480029699674,78.12659579074217],
[17.602483327049022,78.12659581863858],
[17.602489852925945,78.12659587055853],
[17.60249308799231,78.1265959318755],
[17.6024994802554,78.12659608608197],
[17.60250265260742,78.12659616542145],
[17.602508947986863,78.1265964074811],
[17.602512084157492,78.12659659597503],
[17.602518234982078,78.12659692117084],
[17.602521272650083,78.12659711290186],
[17.602527249967434,78.12659761209389],
[17.602530232168906,78.12659789358061],
[17.602536126517617,78.1265985095542],
[17.60253904693578,78.12659884320067],
[17.60254481567594,78.12659963078501],
[17.60254766329336,78.12660008849592],
[17.60255333557496,78.1266010405668],
[17.60255615210817,78.12660153396698],
[17.60256178535902,78.1266026906421],
[17.6025645889844,78.1266033506858],
[17.602570155232854,78.12660477735537],
[17.60257294041219,78.12660554141917],
[17.60257845390883,78.12660715851366],
[17.602581174080772,78.12660804839102],
[17.60258660938374,78.12660995693061],
[17.60258934279305,78.12661094228233],
[17.602594797583254,78.12661305732139],
[17.602597525646445,78.1266141406135],
[17.602602897106316,78.12661647640458],
[17.602605585211084,78.12661775635603],
[17.602610965681762,78.12662042033082],
[17.60261363397504,78.12662178995878],
[17.602619023812377,78.12662470640073],
[17.60262169707727,78.12662625377602],
[17.602626923767257,78.12662961686306],
[17.60262951030422,78.12663132389804],
[17.60263471840253,78.12663483816465],
[17.60263724723199,78.12663671977296],
[17.602642275195123,78.12664072838378],
[17.60264478083699,78.12664279341149],
[17.602649812302488,78.12664701434224],
[17.602652289025883,78.12664919289395],
[17.60265707583566,78.12665385479333],
[17.602659422848312,78.12665621615386],
[17.60266408485073,78.126660963305],
[17.602666425498345,78.1266634442821],
[17.602670971639846,78.12666857804592],
[17.602673153905286,78.1266712318768],
[17.602677529944472,78.1266766430584],
[17.602679708818382,78.12667936139663],
[17.602683991676653,78.12668492183079],
[17.602686045224118,78.12668778891248],
[17.602690149459285,78.12669366870013],
[17.602692184394638,78.1266966518976],
[17.602696157455487,78.12670273725084],
[17.602698073869252,78.12670585081437],
[17.60270191469395,78.12671211439485],
[17.602703767990363,78.12671529928446],
[17.602707451964175,78.12672173003133],
[17.60270926402349,78.1267250074979],
[17.60271279827693,78.12673168406107],
[17.60271451913733,78.12673507597152],
[17.602717922611653,78.1267419498498],
[17.602719574735918,78.12674542976718],
[17.602722796635447,78.12675242385762],
[17.60272438720604,78.12675598076753],
[17.602727402134438,78.12676316215305],
[17.602730346218113,78.12677039197392],
[17.602731806563483,78.12677404456252],
[17.60273462435613,78.1267813506313],
[17.602735925805682,78.12678504029303],
[17.602738471600954,78.12679239927428],
[17.602739713727644,78.12679598982072],
[17.602742076259656,78.1268030903781],
[17.602743132210193,78.12680657200565],
[17.60274514005786,78.126813397182],
[17.602746124475054,78.12681671883072],
[17.602747969554677,78.1268231826124],
[17.60274879413288,78.1268263449505],
[17.602750316219073,78.12683251989068],
[17.602751007896778,78.12683551743534],
[17.602752314613216,78.12684132084217],
[17.602752904643644,78.12684411729727],
[17.60275388719331,78.12684957512342],
[17.602754330463195,78.12685223142361],
[17.602755069540535,78.1268573915123],
[17.6027553931049,78.12685990670518],
[17.602756009646782,78.12686471871396],
[17.602756301771763,78.12686702019127],
[17.60275665135216,78.12687150882198],
[17.602756866253277,78.12687370872194],
[17.60275714883213,78.12687804163302],
[17.602757226521234,78.1268801527681],
[17.602757355747276,78.12688438044381],
[17.602757433223317,78.12688648783443],
[17.602757563670107,78.1268907007199],
[17.60275759134645,78.1268927988771],
[17.60275748700575,78.12689693686744],
[17.60275745860107,78.12689896696175],
[17.602757346415355,78.12690290072905],
[17.60275721682826,78.12690481960877],
[17.602756904357037,78.1269085298236],
[17.602756734226464,78.12691034001433],
[17.60275653419727,78.12691385831253],
[17.602756375992524,78.12691557657745],
[17.60275598692383,78.12691894666092],
[17.60275579478905,78.12692057377076],
[17.602755383841785,78.12692379233569],
[17.60275517783309,78.1269253696076],
[17.602754639652023,78.12692844646405],
[17.602754401037963,78.1269299272967],
[17.602753949268564,78.12693290189719],
[17.60275369025514,78.12693436596157],
[17.602753162211677,78.126937228707],
[17.60275288810467,78.12693862536615],
[17.60275234528854,78.12694137615988],
[17.602752054866265,78.12694273373272],
[17.60275146240288,78.12694538990343],
[17.602751159846644,78.12694669699349],
[17.602750723488782,78.12694917759288],
[17.602750571098962,78.12695023788827],
[17.60274949467056,78.12695235208766],
[17.602749090178392,78.12695364004033],
[17.602748880823242,78.12695614002004],
[17.602748691220967,78.12695722081585],
[17.602747776204808,78.12695934794962],
[17.602747375541078,78.12696046239863],
[17.602746839328105,78.12696268808033],
[17.602746580960886,78.12696377245562],
[17.60274586777544,78.12696589499609],
[17.602745476159335,78.12696696294536],
[17.6027447644898,78.12696908398296],
[17.60274407346915,78.12697121951636],
[17.602743736909076,78.12697226658274],
[17.602743015062803,78.12697413125832],
[17.602742642838567,78.12697491140318],
[17.602742068836896,78.1269767064231],
[17.60274170689574,78.12697777716268],
[17.602741279114213,78.12697884155332],
[17.60274039123559,78.12698081255336],
[17.6027395833124,78.12698280120843],
[17.602739193821964,78.12698381380693],
[17.602738281995297,78.12698593240597],
[17.60273779283196,78.12698703804594],
[17.602736786707393,78.12698930160926],
[17.602736229891697,78.12699047490774],
[17.60273507653327,78.12699295201337],
[17.602734458402207,78.1269942342171],
[17.60273314419476,78.12699690235925],
[17.602732441869673,78.12699829696298],
[17.60273096256017,78.12700118299009],
[17.602730163736698,78.12700267574901],
[17.602728471721925,78.12700576999234],
[17.602727601861194,78.12700737753045],
[17.602725757782032,78.12701070138769],
[17.602724786474948,78.12701239985181],
[17.60272269980763,78.12701591006117],
[17.60272162435039,78.12701774177938],
[17.602719330412622,78.1270214475473],
[17.602718130391313,78.12702338391156],
[17.602715623745702,78.12702732498761],
[17.602714306392176,78.12702935266597],
[17.602711572284694,78.12703351248373],
[17.602710124771967,78.12703563588393],
[17.602707115430015,78.12704003398756],
[17.602705614599508,78.12704228771358],
[17.602702462525446,78.12704682340902],
[17.602700794182173,78.12704906796708],
[17.602697427577947,78.12705368120575],
[17.60269568027666,78.12705601654463],
[17.602692157866823,78.12706066120649],
[17.60269035608959,78.12706302992532],
[17.60268659475622,78.12706780386283],
[17.602684697401113,78.12707020040007],
[17.60268084711111,78.12707493268879],
[17.6026789044643,78.12707729920534],
[17.602674908391336,78.12708204263969],
[17.602672838180524,78.1270843799379],
[17.602668621022264,78.12708901551584],
[17.602666443570747,78.12709132106932],
[17.602661938649952,78.1270959271977],
[17.602659637584768,78.12709813479628],
[17.602654895507527,78.12710245023034],
[17.602652496655956,78.12710460345033],
[17.6026476534076,78.12710881157169],
[17.602645180230937,78.12711085597435],
[17.60263997283286,78.12711472000925],
[17.60263731293284,78.12711658293821],
[17.60263198933254,78.12712029292453],
[17.602629222894365,78.12712205218384],
[17.602623592651273,78.12712545847053],
[17.602620720018958,78.12712705896249],
[17.6026149478183,78.12713006932803],
[17.602612003515166,78.12713155383834],
[17.602605994605533,78.12713423035744],
[17.602602970260822,78.12713543198721],
[17.602596812579048,78.12713772203077],
[17.602593711574713,78.12713881627027],
[17.602587439925564,78.12714081484721],
[17.602584297393303,78.12714176566617],
[17.6025779249021,78.12714333570581],
[17.602574697524766,78.1271439611122],
[17.602568409104375,78.12714513330526],
[17.60256195412955,78.12714610860841],
[17.602558732979364,78.12714649641691],
[17.602552245110683,78.12714711208474],
[17.602548989840617,78.12714734526763],
[17.602542477692737,78.12714763001375],
[17.602539176405738,78.12714771116937],
[17.602532558010076,78.12714781873004],
[17.60252925260266,78.12714785116594],
[17.602525903011006,78.12714778591605],
[17.60251915942595,78.1271475528355],
[17.602512452062708,78.12714734434915],
[17.602509094643608,78.12714715595459],
[17.602502119257903,78.12714671938429],
[17.60249866375655,78.12714650637294],
[17.602491801535137,78.12714609339012],
[17.602488344485682,78.12714586686847],
[17.60248141489924,78.1271453461604],
[17.602477894653045,78.12714511035747],
[17.60247087424691,78.12714468591875],
[17.60246732074003,78.12714443008797],
[17.60246015076373,78.1271438894814],
[17.602456589193725,78.12714365418249],
[17.602449379033107,78.1271431431007],
[17.602445731713733,78.12714287795669],
[17.602438464463923,78.1271423314568],
[17.60243480504347,78.12714207062253],
[17.602427456230547,78.12714150892756],
[17.602423730295616,78.12714122661328],
[17.602416219857872,78.12714063198288],
[17.602412490058832,78.12714031362168],
[17.60240490823951,78.12713969955354],
[17.602401070599736,78.12713938331059],
[17.602393439415067,78.12713875632416],
[17.60238955322592,78.12713841439366],
[17.6023817835043,78.12713783743116],
[17.60237788495075,78.12713749352915],
[17.60236998390288,78.12713676674802],
[17.602366003890083,78.12713647972335],
[17.602358017857735,78.12713588296258],
[17.602354027721855,78.12713545903455],
[17.602345967996037,78.12713476122144],
[17.602341918491124,78.12713446576484],
[17.6023337753515,78.1271338838976],
[17.602329725662887,78.12713350920896],
[17.60232167344165,78.12713278338336],
[17.60231760436974,78.12713243243785],
[17.602309582081734,78.12713190784302],
[17.602305606625375,78.12713160755413],
[17.602297804940815,78.12713091231669],
[17.602293975791863,78.12713059922488],
[17.602286452459374,78.12713002777487],
[17.602282761077696,78.12712977400436],
[17.602275629244392,78.12712918656082],
[17.60227209345688,78.12712888595433],
[17.602265288293353,78.12712834923173],
[17.602261941814955,78.12712810968667],
[17.60225548478139,78.12712760610229],
[17.602252335304833,78.12712732884863],
[17.602246227937368,78.12712683093775],
[17.602243246953048,78.12712654932317],
[17.60223742829036,78.12712607120577],
[17.602234622568567,78.12712582762789],
[17.602229158624205,78.12712528860474],
[17.602226499037002,78.12712507432293],
[17.60222136532726,78.1271245959023],
[17.60221887819126,78.12712435879234],
[17.602214055785268,78.12712394023389],
[17.602211720209894,78.12712370287801],
[17.602207212450722,78.12712327189261],
[17.602205038251284,78.12712307278277],
[17.602200807786247,78.12712267472673],
[17.602198784684177,78.12712247653387],
[17.602194832505734,78.12712208420119],
[17.602191066494974,78.12712171504954],
[17.602189266977195,78.12712153104293],
[17.60218573040426,78.12712121333998],
[17.602184053622043,78.12712106345828],
[17.602180853556625,78.12712072877086],
[17.602179251353505,78.12712048635856],
[17.602176281800443,78.1271202023381],
[17.60217480177094,78.12712005230249],
[17.60217338489673,78.12711991265535],
[17.60217060172429,78.12711963300661],
[17.602167882193047,78.12711934987504],
[17.602166630623863,78.12711915186318],
[17.602164464892727,78.12711902886139],
[17.6021631786711,78.1271192296623],
[17.602160542023473,78.1271188278508],
[17.602159445663386,78.12711838679189],
[17.602157246869925,78.12711826056209],
[17.60215607910512,78.12711833565847],
[17.602153796252853,78.12711812853917],
[17.602152695790345,78.12711791267752],
[17.602150504402058,78.1271177958774],
[17.60214939296851,78.12711773626167],
[17.60214718950691,78.12711753389854],
[17.60214609977504,78.12711741357002],
[17.6021439759386,78.12711711261186],
[17.602142924358613,78.12711694096869],
[17.602140991776675,78.12711715881706],
[17.602140118163177,78.12711728633126],
[17.60213819259782,78.12711666087354],
[17.602137121217375,78.12711640162581],
[17.602134960159514,78.12711638696297],
[17.602133918879538,78.12711640218446],
[17.60213187869109,78.12711608694899],
[17.602130829392493,78.12711593013036],
[17.602128720641353,78.12711574376814],
[17.602127647416246,78.12711569276831],
[17.6021254615375,78.12711542826197],
[17.602124338632283,78.12711530461395],
[17.602121992248517,78.12711507870583],
[17.602120765551373,78.12711496938192],
[17.60211819473157,78.12711467531459],
[17.602116857044543,78.12711452487544],
[17.60211404654125,78.127114266399],
[17.602112633127554,78.1271141061659],
[17.602109618488754,78.127113756317],
[17.602108037521276,78.12711362113241],
[17.60210479245222,78.12711322248289],
[17.60210311260247,78.12711299904056],
[17.602099599495556,78.12711252762074],
[17.60209781867193,78.12711228230353],
[17.602094132488205,78.12711177612053],
[17.602092207631397,78.12711153250953],
[17.602088299717778,78.12711095641191],
[17.602086281077426,78.12711064410757],
[17.602082132278937,78.12710999100283],
[17.60207999167144,78.12710962790587],
[17.60207568721607,78.12710872938855],
[17.60207349273511,78.12710821114717],
[17.602069025349664,78.12710714957348],
[17.602066797597733,78.12710654126748],
[17.602062373169776,78.12710512245947],
[17.60206018465553,78.12710434900828],
[17.602055730462023,78.12710264943395],
[17.602053532260864,78.12710179949771],
[17.602049217412404,78.12709984424525],
[17.6020470532002,78.12709876099836],
[17.60204288426186,78.12709648829733],
[17.602040802315905,78.1270952178362],
[17.602036739024925,78.12709260953643],
[17.60203476293498,78.12709120998662],
[17.602031054425698,78.12708823884397],
[17.602029207742028,78.12708672221349],
[17.60202553194,78.12708357342103],
[17.60202203604598,78.12708031549052],
[17.602020333076446,78.1270785769055],
[17.602017243497485,78.12707480035456],
[17.602015768575637,78.12707281685066],
[17.60201286917489,78.12706894912496],
[17.602011390613708,78.12706703695326],
[17.602008633105232,78.1270630062803],
[17.602007370579138,78.12706085826919],
[17.602006185337757,78.1270586856823],
[17.602003995926708,78.12705426732911],
[17.602001882689198,78.12704976463995],
[17.602000833911738,78.12704749378231],
[17.601998748339593,78.12704287011597],
[17.601997945769416,78.12704047004449],
[17.601996542011264,78.12703547315273],
[17.601995907001516,78.12703295483708],
[17.601994517585744,78.12702798522707],
[17.601993904197187,78.12702545625807],
[17.601993038252715,78.12702022645654],
[17.601992627219737,78.12701759017284],
[17.60199188611297,78.12701227734495],
[17.601991631900507,78.12700958656436],
[17.601991188954948,78.12700414993289],
[17.601990980408406,78.12700137362899],
[17.60199064302308,78.12699585748226],
[17.601990438445927,78.12699306129902],
[17.601990226587723,78.12698744887577],
[17.60199013596025,78.12698460302305],
[17.60198991623593,78.12697889957225],
[17.60198978303006,78.12697601905724],
[17.601989523071353,78.12697021378483],
[17.60198942610239,78.12696732216946],
[17.601989207462434,78.12696152372925],
[17.601989083030716,78.12695861738214],
[17.601988810985354,78.12695280816867],
[17.601988697400362,78.12694994601878],
[17.60198845930863,78.12694422664052],
[17.60198832643767,78.12694138924164],
[17.601988099757317,78.12693576831913],
[17.601987979491252,78.12693302263182],
[17.601987741641707,78.12692767222619],
[17.601987643528474,78.12692507320807],
[17.601987332253323,78.12692001035653],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101],
[17.601987187652668,78.12691756324101]]
wp = 0
message = "A,N,0,0,0,0,0,0,0,0,0\r\n" 
obj.send_data(message)
feed = obj.receive_data()
print(feed)
message = "A,N,0,1,100,0,0,0,0,0,0\r\n"
obj.send_data(message)
time.sleep(1)
feed = obj.receive_data()
print(feed)
message = "A,D,0,0,0,0,0,0,0,0,0 \r\n"
obj.send_data(message)
feed = obj.receive_data()
print(feed)
while not rospy.is_shutdown():
    try:
        if (wp == len(waypoints)-1):
            steer_angle = 0
            obj.send_data('A,D,0,1,100,0,0,0,0,0,0\r\n')
            obj.send_data('A,D,0,1,100,0,0,0,0,0,0\r\n')
            obj.send_data('A,N,0,1,100,0,0,0,0,0,0\r\n')
            time.sleep(1)
            break
        print("waypoint index =============== ",wp)
        position = [float(lat), float(lng)]
        # print("Current position = ", position)
        if ((np.linalg.norm(np.array(position) - waypoints[len(waypoints) - 1]) * wp_threshold) > 1):
            steer_angle = calculate_steer_angle(position, wp, heading)
            print("Steer Angle: ",steer_angle)
            steering_feedback = obj.receive_data().split(',')[2]
            # print("steer Feedback: ",steering_feedback)
            velocity_feedback= obj.receive_data().split(',')[3]
            print("velocity_feedback: ",velocity_feedback)
            steer_rate = pid_controller.update(steer_angle, float(steering_feedback))
            # print("Steer Rate: ",steer_rate)
            # if int(velocity_feedback)> 11:
            #     obj.send_data("A,D,0,1,10,1,"+str(steer_rate)+",0,0,0,0\r\n")
                
            if (steer_angle)>110:
                if int(velocity_feedback)> 7:
                    obj.send_data("A,D,0,1,15,1,"+str(steer_rate)+",0,0,0,0\r\n")
                else:
                    obj.send_data("A,D,7,0,0,1,"+str(steer_rate)+",0,0,0,0\r\n")
            elif int(velocity_feedback)> 10:
                obj.send_data("A,D,0,1,8,1,"+str(steer_rate)+",0,0,0,0\r\n")
            else:
                obj.send_data("A,D,8,0,0,1,"+str(steer_rate)+",0,0,0,0\r\n")
                   
            #time.sleep(1)
            if (wp < len(waypoints) and ((np.linalg.norm(np.array(position) - waypoints[wp]) * wp_threshold) < 6)):
                wp = wp + 1
                # print("\n Waypoint Number : ",wp)
        # else:
        #     steer_angle = 0
        #     obj.send_data('A,N,0,1,90,0,0,0,0,0,0\r\n')
        #     time.sleep(1)
        #     obj.send_data('A,N,O,1,90,0,0,0,0,0,0\r\n')
            
    except rospy.ROSInterruptException:
        pass
